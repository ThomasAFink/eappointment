#!/bin/bash

REALPATH=$(which realpath || which readlink)
REALPATH=$([[ "$REALPATH" =~ 'readlink' ]] && echo "$REALPATH -e" || echo "$REALPATH")
DIR=$(dirname $($REALPATH ${BASH_SOURCE[0]}))
ROOT=$($REALPATH $DIR/..)
LOG=$ROOT/schemavalidation.log

echo "Testing application"
touch $LOG
for filename in $ROOT/schema/*.json
do
    echo "Testing $filename" >> $LOG
    ($ROOT/vendor/bin/validate-json $filename $ROOT/tests/jsonschema4.json >> $LOG)|| (cat $LOG && echo "Validating $filename failed" && exit 1)
done;
rm $LOG
cd $ROOT

$ROOT/vendor/bin/phpcs --standard=psr2 src/ || exit 1
$ROOT/vendor/bin/phpmd src/ text phpmd.rules.xml || exit 1
$ROOT/vendor/bin/phpunit || exit 1
