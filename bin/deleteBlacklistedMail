#!/usr/bin/env php
<?php
$dir = realpath(__DIR__);
do {
    $dir = dirname($dir);
    if (file_exists("$dir/autoload.php")) {
        require_once("$dir/autoload.php");
    }
} while ($dir != '/' && !file_exists("$dir/config.php"));
if (file_exists("$dir/bootstrap.php")) {
    require("$dir/bootstrap.php");
} else {
    require("$dir/config.php");
}
$commit = preg_grep('#^--commit$#', $argv);
$verbose = preg_grep('#^--verbose$#', $argv);


$query = new \BO\Zmsdb\Process();
$mailAddressList = explode(',', (new \BO\Zmsdb\Config)->readProperty('notifications__blacklistedAddressList'));

foreach ($mailAddressList as $mailAddress) {
    $mailAddressList = trim($mailAddress);
    if ($mailAddress) {
        if ($verbose) {
            echo "### DELETE mail address $mailAddress ###\n";
        }
        $results = $query->readProcessListByMailAddress($mailAddress);
        foreach ($results as $process) {
            if ($verbose) {
                echo "  CHANGE $process\n";
            }
            if ($commit) {
                $process->getFirstClient()->email = '';
                $query->updateEntity($process, new \DateTimeImmutable());
            }
        }
    }
}

if (!$commit) {
    echo "Usage: {$argv[0]} --verbose --commit\n\tATTENTION! Delete mail contact from existing process according to a black list. USE WITH CAUTION!\n\n"
        . "\t!!!!!!!!!!!!!!!!!!!!!!!\n"
        . "\t!! DATA LOSS WARNING !!\n"
        . "\t!!!!!!!!!!!!!!!!!!!!!!!\n\n";
}
